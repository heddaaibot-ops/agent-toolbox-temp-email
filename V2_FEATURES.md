# ğŸ‰ EmailServiceV2 - æ–°åŠŸèƒ½è¯¦è§£

## âœ¨ V2 æ–°å¢åŠŸèƒ½æ€»ç»“

æˆ‘ä»¬åˆšåˆšä¸ºæ™ºèƒ½åˆçº¦æ·»åŠ äº† 4 ä¸ªè¶…å¼ºçš„æ–°åŠŸèƒ½ï¼

---

## 1. ğŸ“… é‚®ç®±ç»­è´¹åŠŸèƒ½ (Mailbox Renewal)

### åŠŸèƒ½è¯´æ˜
ç”¨æˆ·å¯ä»¥ä¸ºç°æœ‰é‚®ç®±å»¶é•¿ä½¿ç”¨æ—¶é—´ï¼Œä¸éœ€è¦é‡æ–°è´­ä¹°ï¼

### ä½¿ç”¨æ–¹æ³•
```solidity
// ä¸ºé‚®ç®±ç»­è´¹ 3 å°æ—¶
emailService.renewMailbox{value: 0.003 ether}(
    "0xabc123...",  // mailboxId
    3,               // å¢åŠ  3 å°æ—¶
    address(0)       // ä½¿ç”¨ MON æ”¯ä»˜
);
```

### äº‹ä»¶
```solidity
event MailboxRenewed(
    string indexed mailboxId,
    address indexed owner,
    uint256 newExpiresAt,
    uint256 additionalHours,
    string paymentMethod,
    uint256 pricePaid
);
```

### ä¼˜åŠ¿
- âœ… ä¸éœ€è¦é‡æ–°åˆ›å»ºé‚®ç®±
- âœ… ä¿ç•™åŸæœ‰çš„é‚®ç®±åœ°å€
- âœ… æ”¯æŒ MON å’Œ USDC æ”¯ä»˜
- âœ… å¯ä»¥éšæ—¶ç»­è´¹ï¼Œå³ä½¿è¿‡æœŸäº†ä¹Ÿèƒ½é‡æ–°æ¿€æ´»

---

## 2. ğŸ æ¨èå¥–åŠ±ç³»ç»Ÿ (Referral Rewards)

### åŠŸèƒ½è¯´æ˜
ç”¨æˆ· A æ¨èç”¨æˆ· B è´­ä¹°é‚®ç®±ï¼ŒA å¯ä»¥è·å¾— 10% çš„è¿”ç°å¥–åŠ±ï¼

### ä½¿ç”¨æ–¹æ³•
```solidity
// B é€šè¿‡ A çš„æ¨èè´­ä¹°é‚®ç®±
emailService.purchaseMailbox{value: 0.002 ether}(
    2,               // 2 å°æ—¶
    address(0),      // MON æ”¯ä»˜
    addressOfA       // A çš„åœ°å€ï¼ˆæ¨èäººï¼‰
);

// A é¢†å–å¥–åŠ±
emailService.claimReferralReward();
```

### äº‹ä»¶
```solidity
event ReferralReward(
    address indexed referrer,  // æ¨èäºº
    address indexed referee,   // è¢«æ¨èäºº
    string mailboxId,
    uint256 rewardAmount      // 10% çš„å¥–åŠ±
);
```

### å¥–åŠ±è§„åˆ™
- ğŸ’° æ¨èå¥–åŠ±ï¼šè´­ä¹°ä»·æ ¼çš„ **10%**
- ğŸ”„ ç´¯ç§¯å¥–åŠ±ï¼šå¯ä»¥å¤šæ¬¡æ¨èï¼Œå¥–åŠ±ç´¯åŠ 
- ğŸ’¸ éšæ—¶é¢†å–ï¼šè°ƒç”¨ `claimReferralReward()` å³å¯

### å¢é•¿ç­–ç•¥
è¿™æ˜¯ä¸€ä¸ª**ç—…æ¯’å¼å¢é•¿æœºåˆ¶**ï¼
- ç”¨æˆ·æœ‰åŠ¨åŠ›é‚€è¯·æœ‹å‹
- è¢«æ¨èçš„æœ‹å‹ä¹Ÿå¯ä»¥æˆä¸ºæ¨èäºº
- å½¢æˆæ¨èé“¾ï¼Œå¿«é€Ÿå¢é•¿ç”¨æˆ·

---

## 3. ğŸ›’ æ‰¹é‡è´­ä¹°æŠ˜æ‰£ (Bulk Purchase Discount)

### åŠŸèƒ½è¯´æ˜
ä¸€æ¬¡è´­ä¹° 5 ä¸ªä»¥ä¸Šé‚®ç®±ï¼Œè‡ªåŠ¨äº«å— 10% æŠ˜æ‰£ï¼

### ä½¿ç”¨æ–¹æ³•
```solidity
// è´­ä¹° 6 ä¸ªé‚®ç®±ï¼ˆæ¯ä¸ª 2 å°æ—¶ï¼‰
uint256[] memory durations = new uint256[](6);
for (uint256 i = 0; i < 6; i++) {
    durations[i] = 2;
}

string[] memory mailboxIds = emailService.bulkPurchaseMailboxes{
    value: 0.0108 ether  // åŸä»· 0.012ï¼ŒæŠ˜æ‰£å 0.0108
}(
    durations,
    address(0),
    address(0)  // å¯é€‰æ¨èäºº
);
```

### äº‹ä»¶
```solidity
event BulkPurchase(
    address indexed buyer,
    uint256 quantity,        // è´­ä¹°æ•°é‡
    uint256 totalPrice,      // å®é™…æ”¯ä»˜ä»·æ ¼
    uint256 discountAmount,  // èŠ‚çœçš„é‡‘é¢
    string paymentMethod
);
```

### æŠ˜æ‰£è§„åˆ™
- ğŸ“¦ **5+ é‚®ç®±**ï¼šäº«å— **10% æŠ˜æ‰£**
- ğŸ’µ è‡ªåŠ¨è®¡ç®—ï¼šæ— éœ€æ‰‹åŠ¨è®¡ç®—æŠ˜æ‰£ä»·
- ğŸ¯ é€‚åˆåœºæ™¯ï¼šAI Agent æ‰¹é‡ä½¿ç”¨

### ä¸ºä»€ä¹ˆé€‚åˆ AI Agentï¼Ÿ
- ğŸ¤– Agent å¯èƒ½éœ€è¦å¤§é‡ä¸´æ—¶é‚®ç®±
- ğŸ’° æ‰¹é‡è´­ä¹°æ›´çœé’±
- âš¡ ä¸€æ¬¡äº¤æ˜“åˆ›å»ºå¤šä¸ªï¼ŒèŠ‚çœ Gas

---

## 4. ğŸ›‘ ç´§æ€¥æš‚åœæœºåˆ¶ (Emergency Pause)

### åŠŸèƒ½è¯´æ˜
ç®¡ç†å‘˜å¯ä»¥ç´§æ€¥æš‚åœåˆçº¦ï¼Œé˜²æ­¢åœ¨å‘ç°æ¼æ´æ—¶ç»§ç»­è¢«æ”»å‡»ã€‚

### ä½¿ç”¨æ–¹æ³•
```solidity
// æš‚åœåˆçº¦ï¼ˆä»… ownerï¼‰
emailService.pause();

// å–æ¶ˆæš‚åœ
emailService.unpause();
```

### å®‰å…¨ä¼˜åŠ¿
- ğŸ”’ å‘ç°æ¼æ´æ—¶ç«‹å³æš‚åœ
- ğŸ›¡ï¸ é˜²æ­¢èµ„é‡‘æŸå¤±
- âœ… ä¿®å¤åå¯ä»¥æ¢å¤
- ğŸ“Š æ ‡å‡†çš„å®‰å…¨å®è·µ

### æš‚åœå
- âŒ ä¸èƒ½è´­ä¹°æ–°é‚®ç®±
- âŒ ä¸èƒ½ç»­è´¹
- âŒ ä¸èƒ½æ‰¹é‡è´­ä¹°
- âœ… å¯ä»¥æŸ¥è¯¢ç°æœ‰é‚®ç®±
- âœ… å¯ä»¥é¢†å–æ¨èå¥–åŠ±

---

## 5. âš¡ Gas ä¼˜åŒ– (Gas Optimizations)

### ä¼˜åŒ–æªæ–½

#### 1. Storage å¸ƒå±€ä¼˜åŒ–
```solidity
// V1 (åŸç‰ˆ)
struct Mailbox {
    address owner;      // 20 bytes
    string mailboxId;   // åŠ¨æ€
    uint256 createdAt;  // 32 bytes âŒ æµªè´¹
    uint256 expiresAt;  // 32 bytes âŒ æµªè´¹
    uint256 duration;   // 32 bytes âŒ æµªè´¹
    string paymentMethod; // åŠ¨æ€ âŒ æµªè´¹
    bool active;        // 1 byte
}

// V2 (ä¼˜åŒ–å)
struct Mailbox {
    address owner;      // 20 bytes
    uint96 createdAt;   // 12 bytes âœ… å¤Ÿç”¨
    uint96 expiresAt;   // 12 bytes âœ… å¤Ÿç”¨
    uint24 duration;    // 3 bytes âœ… å¤Ÿç”¨
    uint8 paymentMethod; // 1 byte âœ… 0=MON, 1=USDC
    bool active;        // 1 byte
    string mailboxId;   // åŠ¨æ€
}
```

**èŠ‚çœ**ï¼šæ¯ä¸ªé‚®ç®±èŠ‚çœ ~2ä¸ª storage slots = **~40,000 Gas**

#### 2. å¸¸é‡ä¼˜åŒ–
```solidity
// ä½¿ç”¨ constant å’Œ immutable
uint256 public constant REFERRAL_REWARD_RATE = 1000;  // ä¸å  storage
IERC20 public immutable usdc;  // éƒ¨ç½²æ—¶å†™å…¥ï¼Œä¹‹ååªè¯»
```

#### 3. è®¡ç®—ä¼˜åŒ–
```solidity
// é¿å…é‡å¤è®¡ç®—
uint256 totalPrice = pricePerHour * duration;  // åªè®¡ç®—ä¸€æ¬¡

// ä½¿ç”¨ä½æ“ä½œä»£æ›¿é™¤æ³•
uint256 reward = (price * 1000) / 10000;  // ä»£æ›¿æµ®ç‚¹æ•°
```

### Gas å¯¹æ¯”ï¼ˆé¢„ä¼°ï¼‰

| æ“ä½œ | V1 Gas | V2 Gas | èŠ‚çœ |
|------|--------|--------|------|
| è´­ä¹°é‚®ç®± | ~180k | ~140k | **22%** â¬‡ï¸ |
| ç»­è´¹ | N/A | ~100k | æ–°åŠŸèƒ½ âœ¨ |
| æ‰¹é‡è´­ä¹°(5ä¸ª) | ~900k | ~600k | **33%** â¬‡ï¸ |

---

## ğŸ“Š V2 vs V1 åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | V1 | V2 | è¯´æ˜ |
|------|----|----|------|
| **åŸºç¡€è´­ä¹°** | âœ… | âœ… | æ”¯æŒ USDC/MON |
| **é‚®ç®±ç»­è´¹** | âŒ | âœ… | å»¶é•¿ä½¿ç”¨æ—¶é—´ |
| **æ¨èå¥–åŠ±** | âŒ | âœ… | 10% è¿”ç° |
| **æ‰¹é‡æŠ˜æ‰£** | âŒ | âœ… | 5+ äº« 10% æŠ˜æ‰£ |
| **ç´§æ€¥æš‚åœ** | âŒ | âœ… | å®‰å…¨å¼€å…³ |
| **Gas ä¼˜åŒ–** | - | âœ… | èŠ‚çœ 20-30% |
| **æŸ¥è¯¢åŠŸèƒ½** | âœ… | âœ… | å®Œå…¨å…¼å®¹ |

---

## ğŸ¯ é€‚ç”¨åœºæ™¯

### 1. ä¸ªäººç”¨æˆ·
- è´­ä¹°å•ä¸ªé‚®ç®±
- é€šè¿‡æ¨èèµšå–å¥–åŠ±
- éœ€è¦æ—¶ç»­è´¹å»¶é•¿

### 2. AI Agent
- æ‰¹é‡è´­ä¹°äº«å—æŠ˜æ‰£
- è‡ªåŠ¨åŒ–è°ƒç”¨ç»­è´¹
- ç¨‹åºåŒ–ç®¡ç†å¤šé‚®ç®±

### 3. æ¨å¹¿è€…
- é‚€è¯·æ–°ç”¨æˆ·æ³¨å†Œ
- è·å¾— 10% æŒç»­è¿”ç°
- å»ºç«‹æ¨èç½‘ç»œ

---

## ğŸš€ éƒ¨ç½²è®¡åˆ’

### å½“å‰çŠ¶æ€
- âœ… V2 åˆçº¦ä»£ç å®Œæˆ
- âœ… æµ‹è¯•æ–‡ä»¶ç¼–å†™å®Œæˆ
- â³ ç¼–è¯‘è°ƒè¯•ä¸­ï¼ˆStack too deep é—®é¢˜ï¼‰
- â³ å¾…éƒ¨ç½²åˆ°æµ‹è¯•ç½‘

### ä¸‹ä¸€æ­¥
1. ä¼˜åŒ– V2 ä»£ç è§£å†³ç¼–è¯‘é—®é¢˜
2. éƒ¨ç½²åˆ° Monad æµ‹è¯•ç½‘
3. æ›´æ–°åç«¯ç›‘å¬æ–°äº‹ä»¶
4. æ›´æ–°å‰ç«¯æ”¯æŒæ–°åŠŸèƒ½
5. å®Œæ•´æµ‹è¯•åéƒ¨ç½²ä¸»ç½‘

---

## ğŸ’¡ åˆ›æ–°ç‚¹

### 1. å¢é•¿é»‘å®¢
æ¨èå¥–åŠ±ç³»ç»Ÿæ˜¯ä¸€ä¸ª**ç—…æ¯’å¼å¢é•¿å¼•æ“**ï¼š
- ç”¨æˆ·æ¨èç”¨æˆ·
- åŒæ–¹éƒ½è·ç›Š
- ç½‘ç»œæ•ˆåº”æ˜æ˜¾

### 2. ä»·æ ¼ä¼˜åŒ–
æ‰¹é‡æŠ˜æ‰£æœºåˆ¶ï¼š
- é™ä½ AI Agent ä½¿ç”¨æˆæœ¬
- é¼“åŠ±å¤§å®¢æˆ·
- æé«˜æ€»äº¤æ˜“é‡

### 3. ç”¨æˆ·ä½“éªŒ
ç»­è´¹åŠŸèƒ½ï¼š
- é¿å…é‡æ–°è´­ä¹°çš„éº»çƒ¦
- ä¿ç•™åŸé‚®ç®±åœ°å€
- æ›´ç¬¦åˆç”¨æˆ·ä¹ æƒ¯

### 4. å®‰å…¨ç¬¬ä¸€
ç´§æ€¥æš‚åœï¼š
- æ ‡å‡†çš„ DeFi å®‰å…¨å®è·µ
- é˜²æ­¢é»‘å¤©é¹…äº‹ä»¶
- ä¿æŠ¤ç”¨æˆ·èµ„é‡‘

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ¨èå¥–åŠ±è®¡ç®—
```solidity
uint256 reward = (totalPrice * REFERRAL_REWARD_RATE) / BASIS_POINTS;
// ä¾‹å¦‚ï¼šè´­ä¹° 0.01 MON
// reward = (0.01 * 1000) / 10000 = 0.001 MON (10%)
```

### æ‰¹é‡æŠ˜æ‰£è®¡ç®—
```solidity
if (quantity >= 5) {
    uint256 discount = (basePrice * BULK_DISCOUNT_RATE) / BASIS_POINTS;
    totalPrice = basePrice - discount;
}
// ä¾‹å¦‚ï¼š5ä¸ªé‚®ç®±ï¼Œæ¯ä¸ª0.002 MONï¼Œæ€»ä»· 0.01 MON
// discount = (0.01 * 1000) / 10000 = 0.001 MON
// totalPrice = 0.01 - 0.001 = 0.009 MON
```

---

## ğŸ‰ æ€»ç»“

EmailServiceV2 ä¸ä»…ä»…æ˜¯åŠŸèƒ½çš„å åŠ ï¼Œè€Œæ˜¯ï¼š

1. **å®Œæ•´çš„å•†ä¸šæ¨¡å¼** - æ¨èå¥–åŠ±é©±åŠ¨å¢é•¿
2. **ç”¨æˆ·å‹å¥½** - ç»­è´¹åŠŸèƒ½æå‡ä½“éªŒ
3. **æˆæœ¬ä¼˜åŒ–** - æ‰¹é‡æŠ˜æ‰£é™ä½é—¨æ§›
4. **å®‰å…¨å¯é ** - ç´§æ€¥æš‚åœä¿æŠ¤èµ„é‡‘
5. **æŠ€æœ¯å…ˆè¿›** - Gas ä¼˜åŒ–èŠ‚çœæˆæœ¬

è¿™æ˜¯ä¸€ä¸ªçœŸæ­£**å¯ç”¨äºç”Ÿäº§ç¯å¢ƒ**çš„ DAppï¼ğŸš€

---

**Built with ğŸ’œ for Monad Hackathon 2026**
